name: Build and Release APK

on:
  push:
    tags:
      - 'v*-alpha'
      - 'v*-beta'
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace
      
      - name: Get version info
        id: version
        run: |
          VERSION=$(git describe --tags --always)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
      
      - name: Rename APK
        run: |
          mkdir -p release
          VERSION=${{ steps.version.outputs.version }}
          cp app/build/outputs/apk/debug/app-debug.apk release/locust-tv-${VERSION}.apk
      
      - name: Upload APK as artifact
        uses: actions/upload-artifact@v3
        with:
          name: locust-tv-apk
          path: release/*.apk
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: release/*.apk
          body: |
            ## Locust TV ${{ steps.version.outputs.version }}
            
            **æ„å»ºæ—¶é—´**: ${{ steps.version.outputs.date }}
            
            ### æ›´æ–°å†…å®¹
            
            #### âœ¨ æ–°åŠŸèƒ½
            - é›†æˆ ChannelLoader è‡ªåŠ¨åŠ è½½æœºåˆ¶
            - æ”¯æŒå¤–éƒ¨ M3U æ–‡ä»¶åŠ¨æ€åŠ è½½
            - æ·»åŠ é¢‘é“ç¼“å­˜åŠŸèƒ½ï¼ˆ24å°æ—¶æœ‰æ•ˆæœŸï¼‰
            - ä¼˜åŒ–è®¾ç½®ç•Œé¢ï¼Œæ˜¾ç¤ºæ•°æ®æºçŠ¶æ€å’Œç¼“å­˜ä¿¡æ¯
            
            #### ğŸ”§ æŠ€æœ¯æ”¹è¿›
            - ä½¿ç”¨ jsDelivr CDN åŠ é€Ÿè®¿é—® iptv-org/iptv
            - ä¸‰å±‚å®¹é”™è®¾è®¡ï¼šç¼“å­˜ â†’ å¤–éƒ¨ M3U â†’ å†…ç½®é¢‘é“
            - æ™ºèƒ½å›é€€æœºåˆ¶ï¼Œç¡®ä¿å§‹ç»ˆæœ‰å†…å®¹å¯çœ‹
            - æ”¯æŒ Termux å®šæ—¶æ›´æ–°è„šæœ¬
            
            ### ğŸ“¦ å®‰è£…è¯´æ˜
            
            1. ä¸‹è½½ `locust-tv-${{ steps.version.outputs.version }}.apk`
            2. åœ¨ Android TV ä¸Šå®‰è£…
            3. (å¯é€‰) é…ç½® Termux è‡ªåŠ¨æ›´æ–°è„šæœ¬
            
            ### ğŸš€ é…ç½®è‡ªåŠ¨æ›´æ–°
            
            åœ¨ Android è®¾å¤‡ä¸Šå®‰è£… [Termux](https://f-droid.org/packages/com.termux/)ï¼Œç„¶åæ‰§è¡Œï¼š
            
            ```bash
            bash <(curl -sL https://raw.githubusercontent.com/yanzhao77/locust-tv/main/scripts/setup_cron.sh)
            ```
            
            è¯¥è„šæœ¬ä¼šè‡ªåŠ¨é…ç½®å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©å‡Œæ™¨ 3:00 æ›´æ–°é¢‘é“åˆ—è¡¨ã€‚
            
            ### âš ï¸ å…è´£å£°æ˜
            
            æœ¬åº”ç”¨ä¸æ‰˜ç®¡ä»»ä½•è§†é¢‘å†…å®¹ï¼Œæ‰€æœ‰ç›´æ’­æºå‡æ¥è‡ªå…¬å¼€ç½‘ç»œã€‚ä»…ä¾›ä¸ªäººå­¦ä¹ ä¸ç ”ç©¶ä½¿ç”¨ã€‚
            
            ### ğŸ“ åé¦ˆä¸æ”¯æŒ
            
            - **é—®é¢˜åé¦ˆ**: [GitHub Issues](https://github.com/yanzhao77/locust-tv/issues)
            - **é¡¹ç›®ä¸»é¡µ**: [GitHub Repository](https://github.com/yanzhao77/locust-tv)
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
